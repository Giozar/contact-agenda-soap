<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Contactos</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1>Gestión de Contactos</h1>

    <!-- Formulario -->
    <form id="contact-form">
        <h2 id="form-title">Añadir Contacto</h2>
        <label for="name">Nombre:</label>
        <input type="text" id="name" name="name" placeholder="Ejemplo: Juan Pérez" required>

        <label for="primaryPhone">Teléfono Principal:</label>
        <input type="text" id="primaryPhone" name="primaryPhone" placeholder="Ejemplo: 1234567890" required>

        <label for="mobilePhone">Teléfono Móvil:</label>
        <input type="text" id="mobilePhone" name="mobilePhone" placeholder="Ejemplo: 0987654321" required>

        <label for="email">Correo Electrónico:</label>
        <input type="email" id="email" name="email" placeholder="Ejemplo: juan.perez@correo.com" required>

        <button type="submit">Guardar Contacto</button>
    </form>

    <!-- Barra de Búsqueda -->
    <div>
        <input type="text" id="search-bar" placeholder="Buscar contacto por nombre...">
        <button id="search-button">Buscar</button>
    </div>

    <!-- Lista de Contactos -->
    <div id="contact-list">
        <h2>Contactos</h2>
        <ul id="contacts"></ul>
    </div>

    <script>
        const contactForm = document.getElementById('contact-form');
        const contactList = document.getElementById('contacts');
        const searchBar = document.getElementById('search-bar');

        // Recuperar y mostrar todos los contactos
        async function fetchContacts(sortBy = 'name') {
            try {
                const response = await fetch(`/api/contact/sort`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ criteria: sortBy }),
                });

                if (!response.ok) {
                    throw new Error(`Error en la solicitud: ${response.statusText}`);
                }

                const contacts = await response.json();

                // Limpia la lista y renderiza los contactos
                contactList.innerHTML = '';
                contacts.forEach(contact => {
                    const li = document.createElement('li');
                    li.innerHTML = `
        ${contact.name} - ${contact.primaryPhone}
        <button onclick="editContact('${contact.name}')">Editar</button>
        <button onclick="deleteContact('${contact.name}')">Eliminar</button>
      `;
                    contactList.appendChild(li);
                });
            } catch (error) {
                console.error('Error al obtener contactos:', error);
                alert('No se pudieron cargar los contactos. Verifica tu conexión.');
            }
        }


        // Eliminar un contacto
        async function deleteContact(name) {
            const response = await fetch('/api/contact/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name }),
            });

            const result = await response.json();
            alert(result.message);
            fetchContacts();
        }

        // Editar un contacto
        function editContact(name) {
            const contact = Array.from(document.querySelectorAll('li')).find(li => li.textContent.includes(name));
            const [nameValue, primaryPhone] = contact.textContent.split(' - ');

            document.getElementById('name').value = nameValue.trim();
            document.getElementById('primaryPhone').value = primaryPhone.trim();
            document.getElementById('form-title').textContent = 'Editar Contacto';
        }

        // Guardar o editar contacto
        contactForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(contactForm);
            const data = Object.fromEntries(formData.entries());

            const url = document.getElementById('form-title').textContent === 'Editar Contacto'
                ? '/api/contact/edit'
                : '/api/contact/add';

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();
            alert(result.message);
            document.getElementById('form-title').textContent = 'Añadir Contacto';
            contactForm.reset();
            fetchContacts();
        });

        // Buscar un contacto por nombre
        document.getElementById('search-button').addEventListener('click', async () => {
            const name = searchBar.value;
            const response = await fetch(`/api/contact/search?name=${name}`);
            const contact = await response.json();

            console.log(contact);

            contactList.innerHTML = '';
            const li = document.createElement('li');
            li.textContent = `${contact.name} - ${contact.primaryPhone}`;
            contactList.appendChild(li);
        });

        // Cargar contactos al inicio
        fetchContacts();
    </script>
</body>

</html>